<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>iOS é£æ ¼ç´ æåº“</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ç´ æå›¾åº“">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â˜ï¸</text></svg>">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --app-bg: #f7f8fa;
            --card-bg: #ffffff;
            --primary-color: #6a75ca;
            --primary-gradient: linear-gradient(135deg, #8a94ea, #6a75ca);
            --text-main: #333333;
            --text-sub: #999999;
            --border-color: #eeeeee;
            --danger-color: #ff4757;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --radius-xl: 24px;
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
        }

        * {
            box-sizing: border-box; margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent; outline: none;
            touch-action: manipulation;
        }

        body {
            background-color: var(--app-bg); color: var(--text-main);
            padding-top: calc(60px + var(--safe-top));
            padding-bottom: calc(80px + var(--safe-bottom));
            overflow-x: hidden;
            user-select: none;
        }

        .checkerboard-bg {
            background-color: #2c2c2e;
            background-image: 
                linear-gradient(45deg, #3a3a3c 25%, transparent 25%, transparent 75%, #3a3a3c 75%, #3a3a3c),
                linear-gradient(45deg, #3a3a3c 25%, transparent 25%, transparent 75%, #3a3a3c 75%, #3a3a3c);
            background-size: 16px 16px;
            background-position: 0 0, 8px 8px;
        }

        button, input, select { border: none; background: none; font-size: 14px; user-select: text; }

        .btn-primary {
            background: var(--primary-gradient); color: white;
            padding: 10px 20px; border-radius: 30px; font-weight: 600; font-size: 14px;
            box-shadow: 0 4px 10px rgba(106, 117, 202, 0.3); cursor: pointer; transition: opacity 0.2s;
        }
        .btn-primary:active { opacity: 0.8; }
        .btn-secondary {
            background: #f0f2f5; color: var(--text-main);
            padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 500;
        }
        .btn-icon { padding: 8px; font-size: 20px; color: var(--text-main); cursor: pointer; }/* å…¨å±€ Loading é®ç½© */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(5px);
            z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: all 0.3s;
        }
        .loading-overlay.active { opacity: 1; visibility: visible; }
        .spinner {
            width: 40px; height: 40px; border: 4px solid var(--border-color);
            border-top-color: var(--primary-color); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .navbar {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            padding: calc(10px + var(--safe-top)) 16px 10px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 1px 0 var(--border-color);
        }
        .nav-left { display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 18px; }
        
        .toolbar-container { padding: 16px; background: var(--app-bg); }
        .search-box {
            position: relative; background: #fff; border-radius: var(--radius-md);
            padding: 10px 12px 10px 36px; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-sub); font-size: 16px; }
        .search-input { width: 100%; font-size: 14px; color: var(--text-main); }
        .filters-row { display: flex; justify-content: flex-end; align-items: center; gap: 20px; margin-top: 12px; color: var(--text-sub); font-size: 13px; }
        .filter-item { display: flex; align-items: center; gap: 8px; }

        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e9e9ea; transition: .3s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(20px); }

        .bottom-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(150%);
            width: 90%; max-width: 400px; z-index: 90;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px); padding: 12px 20px; border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .bottom-bar.show { transform: translateX(-50%) translateY(0); }
        .page-input-wrapper { display: flex; align-items: center; gap: 4px; font-size: 14px; color: var(--text-sub); }
        .page-input { width: 40px; text-align: center; border: 1px solid var(--border-color); border-radius: 6px; padding: 4px; font-size: 14px; color: var(--text-main); background: #fff; }
        .btn-batch-del { background: #ffecec; color: var(--danger-color); padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 600; }

        .gallery-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 12px; 
            padding: 0 16px; 
            align-items: start;
        }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-sub); grid-column: 1 / -1; }
        
        .card {
            background: var(--card-bg); border-radius: var(--radius-lg);
            overflow: hidden; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.04);
            transition: transform 0.2s; cursor: pointer; width: 100%;
        }
        .card:active { transform: scale(0.96); }
        .card.selected { border: 2px solid var(--primary-color); box-shadow: 0 0 0 4px rgba(106, 117, 202, 0.2); }
        .card.selected::after {
            content: "âœ“"; position: absolute; top: 10px; right: 10px;
            width: 24px; height: 24px; background: var(--primary-color); color: white;
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; border: 2px solid white;
        }
        .card-img-box { width: 100%; position: relative; display: block; }
        .card-img-box img { width: 100%; height: auto; display: block; pointer-events: none; }
        .card-info { padding: 10px; background: #fff; border-top: 1px solid var(--border-color); }
        .card-title { font-size: 13px; font-weight: 600; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-tags { display: flex; flex-wrap: wrap; gap: 4px; }
        .tag { background: #f0f2f5; color: var(--text-sub); font-size: 11px; padding: 3px 8px; border-radius: 10px; }.preview-list { max-height: 180px; overflow-y: auto; margin-top: 12px; background: #f9f9f9; border-radius: var(--radius-sm); border: 1px solid var(--border-color); display: none; }
        .preview-list.show { display: block; }
        .preview-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); font-size: 13px; }
        .preview-item:last-child { border-bottom: none; }
        .preview-name { width: 55%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-main); }
        .bg-select { padding: 6px; border-radius: 6px; border: 1px solid #ddd; font-size: 12px; background: #fff; color: var(--text-main); }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; opacity: 0; visibility: hidden; transition: all 0.3s; backdrop-filter: blur(5px); }
        .overlay.active { opacity: 1; visibility: visible; }

        .modal-dialog {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            width: 90%; max-width: 360px; background: #fff; border-radius: var(--radius-xl);
            padding: 24px; z-index: 220; opacity: 0; visibility: hidden; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .modal-dialog.active { transform: translate(-50%, -50%) scale(1); opacity: 1; visibility: visible; }
        .modal-title { text-align: center; font-size: 18px; font-weight: 700; margin-bottom: 24px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; color: var(--text-sub); margin-bottom: 8px; }
        .form-input { width: 100%; background: #f5f6f8; padding: 12px; border-radius: var(--radius-md); color: var(--text-main); font-size: 14px;}
        .file-upload-btn { display: inline-block; padding: 8px 16px; background: #edeef9; color: var(--primary-color); border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .modal-actions { display: flex; gap: 12px; margin-top: 30px; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 30px; font-weight: 600; font-size: 15px; cursor: pointer;}
        .btn-cancel { background: #f5f6f8; color: var(--text-sub); }
        .btn-confirm { background: var(--primary-gradient); color: white; box-shadow: 0 4px 10px rgba(106, 117, 202, 0.3); }

        .sidebar {
            position: fixed; top: 0; left: -100%; width: 85%; max-width: 340px; height: 100%;
            background: #fff; z-index: 210; transition: left 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            display: flex; flex-direction: column; padding: calc(20px + var(--safe-top)) 20px calc(20px + var(--safe-bottom));
        }
        .sidebar.active { left: 0; }
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .sidebar-title { font-size: 20px; font-weight: 700; }
        .category-pills { display: flex; flex-wrap: wrap; gap: 10px; align-content: flex-start; flex: 1; overflow-y: auto; }
        .cat-pill { padding: 8px 16px; background: #f5f6f8; color: var(--text-sub); border-radius: 20px; font-size: 14px; transition: all 0.2s; cursor: pointer; }
        .cat-pill.active { background: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(106, 117, 202, 0.3); }
        .backup-area { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .backup-btn { width: 100%; padding: 12px; border-radius: var(--radius-md); margin-bottom: 10px; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer;}
    </style>
</head>
<body><div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div style="color: var(--text-sub); font-size: 14px; font-weight: 600;">å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</div>
    </div>

    <nav class="navbar">
        <div class="nav-left">
            <button class="btn-icon" onclick="toggleSidebar()">â˜°</button>
            <span class="nav-title">ç´ æå›¾åº“</span>
        </div>
        <div class="nav-right">
            <button class="btn-primary" onclick="openModal('addModal')">+ æ–°å¢è®°å½•</button>
        </div>
    </nav>

    <div class="toolbar-container">
        <div class="search-box">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢åç§°ã€æ ‡ç­¾..." oninput="debounceRender()">
        </div>
        <div class="filters-row">
            <div class="filter-item">
                <span>æ‰¹é‡æ¨¡å¼</span>
                <label class="switch">
                    <input type="checkbox" id="batchToggle" onchange="toggleBatchMode()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="filter-item">
                <span>åˆ†é¡µæ˜¾ç¤º</span>
                <label class="switch">
                    <input type="checkbox" id="paginationToggle" checked onchange="renderGallery()">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <div class="gallery-grid" id="galleryGrid"></div>
    
    <div id="emptyState" class="empty-state" style="display: none;">
        <div style="font-size: 48px; margin-bottom: 10px;">ğŸƒ</div>
        <p>æš‚æ— ç›¸å…³ç´ æ</p>
    </div>
    
    <div id="paginationBar" class="bottom-bar show">
        <button id="prevPageBtn" class="btn-secondary" onclick="changePage(-1)">ä¸Šä¸€é¡µ</button>
        <div class="page-input-wrapper">
            ç¬¬ <input type="number" id="pageJumpInput" class="page-input" value="1" min="1" onchange="jumpToPage()"> / <span id="totalPagesDisp">1</span> é¡µ
        </div>
        <button id="nextPageBtn" class="btn-secondary" onclick="changePage(1)">ä¸‹ä¸€é¡µ</button>
    </div>

    <div id="batchActionBar" class="bottom-bar" style="justify-content: space-between; gap: 10px;">
        <button class="btn-secondary" onclick="exitBatchMode()">å–æ¶ˆ</button>
        <span id="selectedCount" style="font-weight: 600; color: var(--text-main); font-size: 14px;">å·²é€‰ 0 é¡¹</span>
        <div class="batch-actions" style="display: flex; gap: 8px;">
            <button class="btn-secondary" style="background: var(--primary-color); color: white;" onclick="batchDownload()">ä¸‹è½½</button>
            <button class="btn-batch-del" onclick="batchDelete()">åˆ é™¤</button>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="closeAllOverlays()"></div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-title">æ ‡ç­¾åˆ†ç±»</span>
            <button class="btn-icon" onclick="toggleSidebar()" style="font-size: 24px;">Ã—</button>
        </div>
        <div class="category-pills" id="categoryPills"></div>
        <div class="backup-area">
             <div style="font-size: 13px; color: var(--text-sub); margin-bottom: 10px;">æ•°æ®ç®¡ç† (æœ¬åœ°å­˜å‚¨)</div>
             <button class="backup-btn" style="background: #333; color: white;" onclick="exportData()">ğŸ“¤ å¯¼å‡ºå¤‡ä»½æ•°æ®</button>
             <button class="backup-btn" style="background: #34c759; color: white;" onclick="document.getElementById('importFile').click()">ğŸ“¥ å¯¼å…¥å¤‡ä»½æ•°æ®</button>
             <input type="file" id="importFile" accept=".json" style="display: none" onchange="importData(event)">
        </div>
    </div><div class="modal-dialog" id="addModal">
        <div class="modal-title">æ–°å¢ç´ æ</div>
        <div class="form-group">
            <label class="form-label">ç»Ÿä¸€åº•è‰² (å¤šå›¾å¯¼å…¥åŒæ•ˆ)</label>
            <select class="form-input" id="globalBgSelect">
                <option value="default">é»˜è®¤åº•è‰²</option>
                <option value="black">çº¯é»‘åº•è‰²</option>
                <option value="white">çº¯ç™½åº•è‰²</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">ç´ æå›¾ç‰‡ (å¿…å¡«)</label>
            <label for="imgUpload" class="file-upload-btn">é€‰æ‹©æ–‡ä»¶</label>
            <span id="fileCountTip" style="font-size: 12px; color: var(--text-sub); margin-left: 8px;">æœªé€‰æ‹©</span>
            <input type="file" id="imgUpload" accept="image/*" multiple style="display: none;" onchange="updateFileTip()">
            <div id="filePreviewList" class="preview-list"></div>
        </div>
        <div class="form-group">
            <label class="form-label">åç§° (å¯é€‰)</label>
            <input type="text" id="imgName" class="form-input" placeholder="é»˜è®¤ä½¿ç”¨æ–‡ä»¶å">
        </div>
        <div class="form-group">
            <label class="form-label">åˆ†ç±»æ ‡ç­¾</label>
            <input type="text" id="imgCategory" class="form-input" placeholder="è¾“å…¥æˆ–é€‰æ‹©æ ‡ç­¾">
            <div id="quickCategorySelect" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; max-height: 86px; overflow-y: auto;"></div>
        </div>
        <div class="modal-actions">
            <button class="modal-btn btn-cancel" onclick="closeModal('addModal')">å–æ¶ˆ</button>
            <button class="modal-btn btn-confirm" onclick="saveImages()">ä¿å­˜è®°å½•</button>
        </div>
    </div>

    <div class="modal-dialog" id="renameModal">
        <div class="modal-title">é‡å‘½åç´ æ</div>
        <div class="form-group">
            <label class="form-label">æ–°åç§°</label>
            <input type="text" id="renameInput" class="form-input" placeholder="è¾“å…¥æ–°åç§°">
            <input type="hidden" id="renameTargetId">
        </div>
        <div class="modal-actions">
            <button class="modal-btn btn-cancel" onclick="closeModal('renameModal')">å–æ¶ˆ</button>
            <button class="modal-btn btn-confirm" onclick="saveRename()">ç¡®è®¤ä¿®æ”¹</button>
        </div>
    </div>

    <div id="imageViewer" style="position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 300; display: none; flex-direction: column;">
        <div style="padding: var(--safe-top) 20px 10px; display: flex; justify-content: space-between; align-items: center; z-index: 310;">
            <button class="btn-secondary" style="background: rgba(255,255,255,0.2); color: white; border-radius: 20px; font-size: 12px;" onclick="toggleViewerBg()">åˆ‡æ¢åº•è‰²æ£€æŸ¥</button>
            <button class="btn-icon" style="color: white; background: rgba(255,255,255,0.2); border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;" onclick="closeImageViewer()">âœ•</button>
        </div>
        <div id="viewerImageContainer" class="checkerboard-bg" style="flex: 1; display: flex; justify-content: center; align-items: center; overflow: hidden; margin: 20px; border-radius: var(--radius-lg); transition: background 0.3s; touch-action: none;">
            <img id="viewerImage" src="" style="max-width: 100%; max-height: 100%; object-fit: contain;">
        </div>
    </div>

<script>
    const DB_NAME = 'iOSGallery_V4';
    const DB_VERSION = 1;
    let db;
    let imagesData = [];
    
    // ç”¨äºå†…å­˜å›æ”¶çš„æ•°ç»„ï¼Œå­˜å‚¨ä¸´æ—¶é¢„è§ˆå›¾åœ°å€
    let tempPreviewUrls = []; 
    
    // è®°å½•ä¸Šä¸€æ¬¡é€‰å®šçš„ç»Ÿä¸€åº•è‰²
    let lastUsedBgColor = 'default';
    
    let appState = {
        currentCategory: 'å…¨éƒ¨',
        currentPage: 1,
        itemsPerPage: 10,
        isBatchMode: false,
        selectedIds: new Set()
    };

    let pressTimer;
    
    function escapeHTML(str) {
        return str.replace(/[&<>'"]/g, tag => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
        }[tag] || tag));
    }

    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = e => { alert('æ•°æ®åº“é”™è¯¯'); reject(e); };
            request.onsuccess = e => { db = e.target.result; resolve(); };
            request.onupgradeneeded = e => {
                db = e.target.result;
                if (!db.objectStoreNames.contains('images')) {
                    db.createObjectStore('images', { keyPath: 'id' });
                }
            };
        });
    }

    async function loadData() {
        const transaction = db.transaction(['images'], 'readonly');
        const request = transaction.objectStore('images').getAll();
        request.onsuccess = () => {
            imagesData = request.result.sort((a, b) => b.timestamp - a.timestamp);
            updateCategoryUI();
            renderGallery();
        };
    }

    function dbAction(mode, actionFunc) {
        return new Promise((resolve, reject) => {
            const transaction = db.transaction(['images'], mode);
            const store = transaction.objectStore('images');
            actionFunc(store);
            transaction.oncomplete = resolve;
            transaction.onerror = reject;
        });
    }function updateCategoryUI() {
        const categories = new Set(imagesData.map(img => img.category).filter(c => c));
        const pillsContainer = document.getElementById('categoryPills');
        const quickSelect = document.getElementById('quickCategorySelect'); 
        
        let pillsHtml = `<div class="cat-pill ${appState.currentCategory === 'å…¨éƒ¨' ? 'active' : ''}" onclick="selectCategory('å…¨éƒ¨')">å…¨éƒ¨</div>`;
        let quickSelectHtml = ''; 
        
        categories.forEach(cat => {
            const escapedCatHTML = escapeHTML(cat);
            const safeJsStr = cat.replace(/\\/g, '\\\\').replace(/'/g, "\\'"); 
            
            pillsHtml += `<div class="cat-pill ${appState.currentCategory === cat ? 'active' : ''}" onclick="selectCategory('${safeJsStr}')">${escapedCatHTML}</div>`;
            quickSelectHtml += `<div class="cat-pill" style="padding: 4px 10px; font-size: 12px; margin: 0; background: #edeef9; color: var(--primary-color);" onclick="document.getElementById('imgCategory').value = '${safeJsStr}'">${escapedCatHTML}</div>`;
        });
        
        if (pillsContainer) pillsContainer.innerHTML = pillsHtml;
        if (quickSelect) quickSelect.innerHTML = quickSelectHtml; 
    }

    function renderGallery() {
        const container = document.getElementById('galleryGrid');
        const searchQ = document.getElementById('searchInput').value.toLowerCase().trim();
        const isPaginated = document.getElementById('paginationToggle').checked;
        
        let filtered = imagesData.filter(img => {
            let catMatch = appState.currentCategory === 'å…¨éƒ¨' || img.category === appState.currentCategory;
            let searchMatch = !searchQ || img.name.toLowerCase().includes(searchQ) || img.category.toLowerCase().includes(searchQ);
            return catMatch && searchMatch;
        });

        const emptyState = document.getElementById('emptyState');
        if (filtered.length === 0) {
            emptyState.style.display = 'block';
            container.innerHTML = '';
            updatePaginationUI(0);
            return;
        } else {
            emptyState.style.display = 'none';
        }

        const totalPages = Math.ceil(filtered.length / appState.itemsPerPage) || 1;
        if (appState.currentPage > totalPages) appState.currentPage = totalPages;
        if (appState.currentPage < 1) appState.currentPage = 1;
        
        let displayData = filtered;
        if (isPaginated) {
            const start = (appState.currentPage - 1) * appState.itemsPerPage;
            displayData = filtered.slice(start, start + appState.itemsPerPage);
        }
        updatePaginationUI(totalPages);

        container.innerHTML = displayData.map(img => {
            const isSelected = appState.selectedIds.has(img.id);
            const safeName = img.name.replace(/'/g, "\\'");
            const bgColor = img.bgColor || 'default';
            
            if (img.data instanceof Blob && !img.blobUrl) {
                img.blobUrl = URL.createObjectURL(img.data);
            }
            const srcUrl = img.blobUrl || img.data; 
            
            let bgClass = bgColor === 'default' ? 'checkerboard-bg' : '';
            let bgInline = bgColor === 'black' ? 'background-color: #000000;' : (bgColor === 'white' ? 'background-color: #ffffff;' : '');
            
            // å·²ä½¿ç”¨å®‰å…¨çš„ dataset (data-*) æ›¿æ¢åŸå…ˆçš„æ˜“é”™æ­£åˆ™ä¼ å‚
            return `
                <div class="card ${isSelected ? 'selected' : ''}" 
                     data-id="${img.id}" data-src="${srcUrl}" data-bg="${bgColor}"
                     oncontextmenu="event.preventDefault();"
                     onmousedown="handlePressStart('${img.id}', '${safeName}')" 
                     onmouseup="handlePressEnd()" 
                     onmouseleave="handlePressEnd()"
                     ontouchstart="handlePressStart('${img.id}', '${safeName}')" 
                     ontouchend="handlePressEnd()" 
                     ontouchcancel="handlePressEnd()"
                     ontouchmove="handlePressEnd()">
                    <div class="card-img-box ${bgClass}" style="${bgInline}">
                        <img src="${srcUrl}" loading="lazy">
                    </div>
                    <div class="card-info">
                        <div class="card-title">${escapeHTML(img.name)}</div>
                        <div class="card-tags"><span class="tag">${escapeHTML(img.category)}</span></div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function updatePaginationUI(totalPages) {
        const pagBar = document.getElementById('paginationBar');
        const isPaginated = document.getElementById('paginationToggle').checked;
        pagBar.classList.toggle('show', isPaginated && !appState.isBatchMode && totalPages > 0);
        
        document.getElementById('pageJumpInput').value = appState.currentPage;
        document.getElementById('pageJumpInput').max = totalPages;
        document.getElementById('totalPagesDisp').innerText = totalPages;
        document.getElementById('prevPageBtn').disabled = appState.currentPage === 1;
        document.getElementById('nextPageBtn').disabled = appState.currentPage === totalPages || totalPages === 0;
    }    let isLongPress = false;
    // ç®€åŒ–åçš„é•¿æŒ‰ä¼ å‚
    function handlePressStart(id, name) {
        isLongPress = false;
        clearTimeout(pressTimer);
        pressTimer = setTimeout(() => {
            isLongPress = true; 
            if (!appState.isBatchMode) openRenameModal(id, name);
        }, 600);
    }

    function handlePressEnd() { clearTimeout(pressTimer); }

    function handleBatchClick(id, cardElement) { 
        if (appState.selectedIds.has(id)) {
            appState.selectedIds.delete(id);
            if (cardElement) cardElement.classList.remove('selected');
        } else {
            appState.selectedIds.add(id);
            if (cardElement) cardElement.classList.add('selected');
        }
        updateBatchUI(); 
    }

    // å·²ä¿®å¤çš„å…¨å±é¢„è§ˆ/æ‰¹é‡é€‰ä¸­äº‹ä»¶ç›‘å¬
    document.getElementById('galleryGrid').addEventListener('click', function(e) {
        const card = e.target.closest('.card');
        if (!card || isLongPress) return; 
        
        // ä½¿ç”¨ dataset è·å–æ•°æ®ï¼Œå½»åº•å‘Šåˆ«æ­£åˆ™å´©æºƒ
        const id = card.dataset.id;
        const src = card.dataset.src;
        const bgColor = card.dataset.bg;

        if (id && src) {
            if (appState.isBatchMode) {
                handleBatchClick(id, card); 
            } else {
                openImageViewer(src, bgColor);
            }
        }
    });

    function changePage(delta) { appState.currentPage += delta; renderGallery(); }
    function jumpToPage() {
        const input = document.getElementById('pageJumpInput');
        let val = parseInt(input.value);
        const max = parseInt(document.getElementById('totalPagesDisp').innerText);
        if (isNaN(val) || val < 1) val = 1;
        if (val > max) val = max;
        appState.currentPage = val;
        renderGallery();
    }

    let searchTimeout;
    function debounceRender() { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => { appState.currentPage = 1; renderGallery(); }, 300); }

    function openRenameModal(id, currentName) {
        navigator.vibrate && navigator.vibrate(50); 
        document.getElementById('renameTargetId').value = id;
        document.getElementById('renameInput').value = currentName;
        openModal('renameModal');
    }

    async function saveRename() {
        const id = document.getElementById('renameTargetId').value;
        const newName = document.getElementById('renameInput').value.trim();
        if (!newName) return alert("åç§°ä¸èƒ½ä¸ºç©º");
        
        const imgIndex = imagesData.findIndex(img => img.id === id);
        if (imgIndex > -1) {
            imagesData[imgIndex].name = newName;
            await dbAction('readwrite', store => store.put(imagesData[imgIndex]));
            renderGallery();
            closeModal('renameModal');
        }
    }

    function selectCategory(cat) { appState.currentCategory = cat; appState.currentPage = 1; closeAllOverlays(); renderGallery(); updateCategoryUI(); }
    
    function toggleBatchMode() { 
        appState.isBatchMode = document.getElementById('batchToggle').checked; 
        if (!appState.isBatchMode) {
            document.querySelectorAll('.card.selected').forEach(el => el.classList.remove('selected'));
        }
        appState.selectedIds.clear(); 
        updateBatchUI(); 
    }

    function exitBatchMode() {
        document.getElementById('batchToggle').checked = false;
        appState.isBatchMode = false;
        appState.selectedIds.clear();
        updateBatchUI();
        document.querySelectorAll('.card.selected').forEach(el => el.classList.remove('selected'));
    }
 
    function updateBatchUI() {
        const batchBar = document.getElementById('batchActionBar');
        const pagBar = document.getElementById('paginationBar');
        if (appState.isBatchMode) { batchBar.classList.add('show'); pagBar.classList.remove('show'); } 
        else { batchBar.classList.remove('show'); updatePaginationUI(parseInt(document.getElementById('totalPagesDisp').innerText)); }
        document.getElementById('selectedCount').innerText = `å·²é€‰ ${appState.selectedIds.size} é¡¹`;
    }
    
    // --- æ–°å¢ï¼šä¸“é—¨æ¸…ç†ä¸´æ—¶é¢„è§ˆå›¾å†…å­˜çš„å‡½æ•° ---
    function clearTempPreviews() {
        if (tempPreviewUrls.length > 0) {
            tempPreviewUrls.forEach(url => URL.revokeObjectURL(url));
            tempPreviewUrls = [];
        }
    }

    // --- å·²ä¿®å¤ï¼šèƒ½å¤Ÿç”Ÿæˆå›¾ç‰‡ç¼©ç•¥å›¾ï¼Œå¹¶è®°å½•å†…å­˜ä¾›åç»­é”€æ¯ ---
    function updateFileTip() { 
        const files = document.getElementById('imgUpload').files;
        const count = files.length;
        document.getElementById('fileCountTip').innerText = count > 0 ? `å·²é€‰æ‹© ${count} ä¸ªæ–‡ä»¶` : 'æœªé€‰æ‹©'; 
        
        const previewList = document.getElementById('filePreviewList');
        
        // æ¯æ¬¡é‡æ–°é€‰æ‹©æ–‡ä»¶æ—¶ï¼Œå…ˆæ¸…ç©ºä¸Šä¸€æ¬¡ç”Ÿæˆçš„é¢„è§ˆå†…å­˜
        clearTempPreviews();

        if (count > 0) {
            previewList.classList.add('show');
            previewList.innerHTML = Array.from(files).map((file) => {
                const tempUrl = URL.createObjectURL(file);
                tempPreviewUrls.push(tempUrl); // è®°å½•ä¸‹æ¥ä»¥ä¾¿å›æ”¶
                
                return `
                <div class="preview-item" style="display: flex; gap: 10px; align-items: center;">
                    <img src="${tempUrl}" style="width: 40px; height: 40px; object-fit: cover; border-radius: var(--radius-sm);">
                    <span class="preview-name" style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${file.name}">${file.name}</span>
                </div>
                `;
            }).join('');
            document.getElementById('globalBgSelect').value = lastUsedBgColor;
        } else {
            previewList.classList.remove('show');
            previewList.innerHTML = '';
        }
    }

    async function saveImages() {
        const files = document.getElementById('imgUpload').files;
        const customName = document.getElementById('imgName').value.trim();
        const category = document.getElementById('imgCategory').value.trim() || 'é»˜è®¤åˆ†ç±»';
        if (files.length === 0) return alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡');
        
        document.getElementById('loadingOverlay').classList.add('active');
        lastUsedBgColor = document.getElementById('globalBgSelect').value || 'default';

        try {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const bgChoice = lastUsedBgColor;
                const name = (files.length === 1 && customName) ? customName : file.name.replace(/\.[^/.]+$/, "");
                
                await dbAction('readwrite', store => store.put({ 
                    id: Date.now() + '_' + Math.random().toString(36).substr(2, 5), 
                    name: name, 
                    category: category, 
                    data: file,  
                    bgColor: bgChoice,
                    timestamp: Date.now() 
                }));
            }
            
            closeModal('addModal');
            await loadData();
        } catch (err) {
            console.error(err);
            alert("ä¿å­˜æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥å­˜å‚¨ç©ºé—´");
        } finally {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
    }
    async function batchDelete() {
        if (appState.selectedIds.size === 0) return;
        if (!confirm(`ç¡®å®šåˆ é™¤é€‰å®šçš„ ${appState.selectedIds.size} é¡¹ç´ æå—ï¼Ÿ`)) return;
        
        for (let id of appState.selectedIds) {
            // --- å†…å­˜å›æ”¶ï¼šå¦‚æœå›¾ç‰‡æœ‰ç”Ÿæˆçš„ blobUrlï¼Œä»å†…å­˜ä¸­é‡Šæ”¾å®ƒ ---
            const img = imagesData.find(i => i.id === id);
            if (img && img.blobUrl) {
                URL.revokeObjectURL(img.blobUrl);
            }
            await dbAction('readwrite', store => store.delete(id));
        }
        
        appState.selectedIds.clear(); updateBatchUI(); loadData();
    }

    async function batchDownload() {
        if (appState.selectedIds.size === 0) return;
        const idArray = Array.from(appState.selectedIds);
        for (let id of idArray) {
            const img = imagesData.find(i => i.id === id);
            if (img) { 
                const a = document.createElement('a'); 
                const tempUrl = img.data instanceof Blob ? URL.createObjectURL(img.data) : img.data;
                a.href = tempUrl; 
                a.download = img.name; 
                document.body.appendChild(a); 
                a.click(); 
                document.body.removeChild(a); 
                if (img.data instanceof Blob) URL.revokeObjectURL(tempUrl);
                await new Promise(resolve => setTimeout(resolve, 600));
            }
        }
    }

    async function exportData() {
        if (imagesData.length === 0) return alert('æ— å¯å¯¼å‡ºæ•°æ®');
        document.getElementById('loadingOverlay').classList.add('active'); 
        
        try {
            const exportArray = await Promise.all(imagesData.map(async img => {
                let base64Data = img.data;
                if (img.data instanceof Blob) {
                    base64Data = await new Promise(r => { const reader = new FileReader(); reader.onload = e => r(e.target.result); reader.readAsDataURL(img.data); });
                }
                // å¯¼å‡ºæ—¶ä¸è¦å¸¦ä¸Šä¸´æ—¶çš„ blobUrl
                const exportItem = { ...img, data: base64Data };
                delete exportItem.blobUrl;
                return exportItem;
            }));
            
            const blob = new Blob([JSON.stringify(exportArray)], { type: "application/json" });
            const url = URL.createObjectURL(blob); 
            const a = document.createElement('a'); a.href = url; a.download = `GalleryBackup_${Date.now()}.json`; a.click(); 
            URL.revokeObjectURL(url);
        } catch (e) {
            alert("å¯¼å‡ºå¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½è¿‡å¤§");
        } finally {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
    }

    async function importData(event) {
        const file = event.target.files[0];
        if (!file || !confirm("å¯¼å…¥å°†è¦†ç›–ç°æœ‰æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šå—ï¼Ÿ")) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = JSON.parse(e.target.result);
                await dbAction('readwrite', store => { store.clear(); data.forEach(item => store.put(item)); });
                alert('å¯¼å…¥æˆåŠŸ'); closeAllOverlays(); loadData();
            } catch (err) { alert('å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯'); }
            event.target.value = '';
        };
        reader.readAsText(file);
    }

    function toggleSidebar() { const sb = document.getElementById('sidebar'); const ol = document.getElementById('overlay'); sb.classList.contains('active') ? closeAllOverlays() : (sb.classList.add('active'), ol.classList.add('active')); }
    function openModal(modalId) { closeAllOverlays(); document.getElementById(modalId).classList.add('active'); document.getElementById('overlay').classList.add('active'); }
    
    function closeModal(modalId) { 
        document.getElementById(modalId).classList.remove('active'); 
        document.getElementById('overlay').classList.remove('active'); 
        
        // --- å†…å­˜å›æ”¶ä¸é‡ç½®ï¼šå¦‚æœå…³é—­çš„æ˜¯ä¸Šä¼ å¼¹çª—ï¼Œæ¸…ç†çŠ¶æ€ ---
        if (modalId === 'addModal') {
            clearTempPreviews();
            document.getElementById('imgUpload').value = ''; 
            document.getElementById('imgName').value = ''; 
            document.getElementById('fileCountTip').innerText = 'æœªé€‰æ‹©';
            document.getElementById('filePreviewList').innerHTML = '';
            document.getElementById('filePreviewList').classList.remove('show');
        }
    }
    
    function closeAllOverlays() { 
        document.getElementById('sidebar').classList.remove('active'); 
        document.querySelectorAll('.modal-dialog').forEach(m => {
            m.classList.remove('active');
            if (m.id === 'addModal') closeModal('addModal'); // ç¡®ä¿èµ°æ¸…ç†é€»è¾‘
        }); 
        document.getElementById('overlay').classList.remove('active'); 
    }
    
    function openImageViewer(src, bgColor = 'default') { 
        document.getElementById('viewerImage').src = src; 
        document.getElementById('imageViewer').style.display = 'flex'; 
        
        const container = document.getElementById('viewerImageContainer');
        container.className = '';
        container.style.backgroundColor = '';
        
        if (bgColor === 'black') {
            viewerBgState = 1;
            container.style.backgroundColor = '#000000';
        } else if (bgColor === 'white') {
            viewerBgState = 2;
            container.style.backgroundColor = '#ffffff';
        } else {
            viewerBgState = 0;
            container.classList.add('checkerboard-bg');
        }
        resetZoom();
    }
    
    function closeImageViewer() { 
        document.getElementById('imageViewer').style.display = 'none'; 
        resetZoom();
    }
    
    let viewerBgState = 0; 
    function toggleViewerBg() {
        const container = document.getElementById('viewerImageContainer');
        viewerBgState = (viewerBgState + 1) % 3;
        container.className = '';
        if (viewerBgState === 0) {
            container.classList.add('checkerboard-bg');
            container.style.backgroundColor = '';
        } else if (viewerBgState === 1) {
            container.style.backgroundColor = '#000000';
        } else {
            container.style.backgroundColor = '#ffffff';
        }
    }

    let currentScale = 1, initialDist = 0, startX = 0, startY = 0;
    let translateX = 0, translateY = 0, isPanning = false;
    const vImg = document.getElementById('viewerImage');
    const vCont = document.getElementById('viewerImageContainer');

    function resetZoom() {
        currentScale = 1; translateX = 0; translateY = 0;
        vImg.style.transform = `translate(0px, 0px) scale(1)`;
        vImg.style.transition = 'transform 0.2s';
    }

    vCont.addEventListener('touchstart', e => {
        vImg.style.transition = 'none'; 
        if (e.touches.length === 2) {
            initialDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
        } else if (e.touches.length === 1 && currentScale > 1) {
            isPanning = true;
            startX = e.touches[0].pageX - translateX;
            startY = e.touches[0].pageY - translateY;
        }
    });

    vCont.addEventListener('touchmove', e => {
        if (e.touches.length === 2) {
            e.preventDefault(); 
            const currentDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
            let scale = (currentDist / initialDist) * currentScale;
            scale = Math.min(Math.max(0.5, scale), 5);
            vImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
        } else if (e.touches.length === 1 && isPanning) {
            e.preventDefault();
            translateX = e.touches[0].pageX - startX;
            translateY = e.touches[0].pageY - startY;
            vImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
        }
    }, {passive: false});

    vCont.addEventListener('touchend', e => {
        if (e.touches.length < 2) {
            const match = vImg.style.transform.match(/scale\(([^)]+)\)/);
            if (match) currentScale = parseFloat(match[1]);
            if (currentScale < 1) resetZoom();
        }
        if (e.touches.length === 0) isPanning = false;
    });

    initDB().then(loadData);
</script>
</body>
</html>
